# Drupal 11 on AKS Infrastructure Diagram

## High-Level Architecture

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                    INTERNET                                              │
│                                                                                          │
│                              Users → libutk.com                                          │
└───────────────────────────────────────┬─────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                           AZURE (eastus region)                                          │
│  ┌────────────────────────────────────────────────────────────────────────────────────┐ │
│  │                        Static Public IP: 172.171.194.237                           │ │
│  └────────────────────────────────────────────────────────────────────────────────────┘ │
│                                        │                                                 │
│                                        ▼                                                 │
│  ┌────────────────────────────────────────────────────────────────────────────────────┐ │
│  │                    AKS CLUSTER: drupalcsi-test-aks                                 │ │
│  │  ┌──────────────────────────────────────────────────────────────────────────────┐  │ │
│  │  │                         FLUX-SYSTEM NAMESPACE                                │  │ │
│  │  │  ┌─────────────────┐  ┌─────────────────┐  ┌────────────────────────────┐   │  │ │
│  │  │  │ source-controller│  │kustomize-ctrl   │  │ image-reflector-controller │   │  │ │
│  │  │  │ (watches Git)    │  │ (applies YAML)  │  │ (watches ACR for new tags) │   │  │ │
│  │  │  └────────┬─────────┘  └────────┬────────┘  └─────────────┬──────────────┘   │  │ │
│  │  │           │                     │ SOPS decrypt            │                  │  │ │
│  │  │           ▼                     ▼ via Workload ID         ▼                  │  │ │
│  │  │  ┌───────────────────────────────────────────────────────────────────────┐   │  │ │
│  │  │  │              GitRepository: drupal-gitops (GitHub)                    │   │  │ │
│  │  │  └───────────────────────────────────────────────────────────────────────┘   │  │ │
│  │  └──────────────────────────────────────────────────────────────────────────────┘  │ │
│  │                                        │                                           │ │
│  │            ┌───────────────────────────┼───────────────────────────┐               │ │
│  │            │                           │                           │               │ │
│  │            ▼                           ▼                           ▼               │ │
│  │  ┌─────────────────────┐    ┌─────────────────────┐    ┌─────────────────────┐    │ │
│  │  │  INFRASTRUCTURE     │    │    CERTIFICATES     │    │       APPS          │    │ │
│  │  │   Kustomization     │◄───│    Kustomization    │◄───│    Kustomization    │    │ │
│  │  │                     │    │                     │    │   (depends on       │    │ │
│  │  │                     │    │  (depends on infra) │    │    migration)       │    │ │
│  │  └──────────┬──────────┘    └──────────┬──────────┘    └──────────┬──────────┘    │ │
│  │             │                          │                          │               │ │
│  │             ▼                          ▼                          ▼               │ │
│  │  ┌──────────────────────────────────────────────────────────────────────────────┐ │ │
│  │  │                        TRAEFIK NAMESPACE                                     │ │ │
│  │  │  ┌────────────────────────────────────────────────────────────────────────┐  │ │ │
│  │  │  │                     TRAEFIK INGRESS CONTROLLER                         │  │ │ │
│  │  │  │  • HelmRelease from Helm chart                                         │  │ │ │
│  │  │  │  • LoadBalancer Service → Static IP                                    │  │ │ │
│  │  │  │  • TLS termination (Let's Encrypt certs)                               │  │ │ │
│  │  │  │  • Security headers middleware                                         │  │ │ │
│  │  │  │  • Rate limiting middleware                                            │  │ │ │
│  │  │  └────────────────────────────────────────────────────────────────────────┘  │ │ │
│  │  └──────────────────────────────────────────────────────────────────────────────┘ │ │
│  │                                        │                                           │ │
│  │  ┌──────────────────────────────────────────────────────────────────────────────┐ │ │
│  │  │                       CERT-MANAGER NAMESPACE                                 │ │ │
│  │  │  ┌────────────────────────────────────────────────────────────────────────┐  │ │ │
│  │  │  │                        CERT-MANAGER                                    │  │ │ │
│  │  │  │  • HelmRelease from Helm chart                                         │  │ │ │
│  │  │  │  • ClusterIssuer: letsencrypt-production                               │  │ │ │
│  │  │  │  • HTTP-01 challenge via Traefik                                       │  │ │ │
│  │  │  │  • Auto-renews TLS certificates                                        │  │ │ │
│  │  │  └────────────────────────────────────────────────────────────────────────┘  │ │ │
│  │  └──────────────────────────────────────────────────────────────────────────────┘ │ │
│  │                                        │                                           │ │
│  │  ┌──────────────────────────────────────────────────────────────────────────────┐ │ │
│  │  │                          DRUPAL NAMESPACE                                    │ │ │
│  │  │  ┌─────────────────────────────────────────────────────────────────────────┐ │ │ │
│  │  │  │                    MIGRATION JOB (runs first)                           │ │ │ │
│  │  │  │  • drush updatedb (database migrations)                                 │ │ │ │
│  │  │  │  • drush config:import (configuration sync)                             │ │ │ │
│  │  │  │  • drush cache:rebuild                                                  │ │ │ │
│  │  │  │  • backoffLimit: 0 (no auto-retry)                                      │ │ │ │
│  │  │  └─────────────────────────────────────────────────────────────────────────┘ │ │ │
│  │  │                                     │ success                                │ │ │
│  │  │                                     ▼                                        │ │ │
│  │  │  ┌─────────────────────────────────────────────────────────────────────────┐ │ │ │
│  │  │  │                      DRUPAL DEPLOYMENT                                  │ │ │ │
│  │  │  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                     │ │ │ │
│  │  │  │  │   Pod 1     │  │   Pod 2     │  │   Pod 3     │  (3 replicas)       │ │ │ │
│  │  │  │  │  ┌───────┐  │  │  ┌───────┐  │  │  ┌───────┐  │                     │ │ │ │
│  │  │  │  │  │ nginx │  │  │  │ nginx │  │  │  │ nginx │  │                     │ │ │ │
│  │  │  │  │  └───┬───┘  │  │  └───┬───┘  │  │  └───┬───┘  │                     │ │ │ │
│  │  │  │  │      │      │  │      │      │  │      │      │                     │ │ │ │
│  │  │  │  │  ┌───▼───┐  │  │  ┌───▼───┐  │  │  ┌───▼───┐  │                     │ │ │ │
│  │  │  │  │  │php-fpm│  │  │  │php-fpm│  │  │  │php-fpm│  │                     │ │ │ │
│  │  │  │  │  └───────┘  │  │  └───────┘  │  │  └───────┘  │                     │ │ │ │
│  │  │  │  │ (Supervisor)│  │ (Supervisor)│  │ (Supervisor)│                     │ │ │ │
│  │  │  │  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘                     │ │ │ │
│  │  │  │         │                │                │                            │ │ │ │
│  │  │  │         └────────────────┼────────────────┘                            │ │ │ │
│  │  │  │                          │                                             │ │ │ │
│  │  │  │                          ▼                                             │ │ │ │
│  │  │  │  ┌─────────────────────────────────────────────────────────────────┐   │ │ │ │
│  │  │  │  │                        VOLUMES                                  │   │ │ │ │
│  │  │  │  │  ┌─────────────────────────────────────────────────────────┐    │   │ │ │ │
│  │  │  │  │  │ PVC: drupal-files (Azure Blob NFS)                      │    │   │ │ │ │
│  │  │  │  │  │ Mount: /var/www/html/web/sites/default/files            │    │   │ │ │ │
│  │  │  │  │  │ Options: actimeo=60, nconnect=8                         │    │   │ │ │ │
│  │  │  │  │  └─────────────────────────────────────────────────────────┘    │   │ │ │ │
│  │  │  │  │  ┌─────────────────┐  ┌─────────────────────────────────────┐   │   │ │ │ │
│  │  │  │  │  │ emptyDir: /tmp  │  │ emptyDir: /var/www/private          │   │   │ │ │ │
│  │  │  │  │  │ (Memory-backed) │  │ (ephemeral private files)           │   │   │ │ │ │
│  │  │  │  │  │ Twig cache here │  │                                     │   │   │ │ │ │
│  │  │  │  │  └─────────────────┘  └─────────────────────────────────────┘   │   │ │ │ │
│  │  │  │  └─────────────────────────────────────────────────────────────────┘   │ │ │ │
│  │  │  └─────────────────────────────────────────────────────────────────────────┘ │ │ │
│  │  │                                                                              │ │ │
│  │  │  ┌─────────────────────────────────────────────────────────────────────────┐ │ │ │
│  │  │  │                       DRUPAL CRONJOB                                    │ │ │ │
│  │  │  │  • Runs every 15 minutes                                                │ │ │ │
│  │  │  │  • drush cron                                                           │ │ │ │
│  │  │  └─────────────────────────────────────────────────────────────────────────┘ │ │ │
│  │  │                                                                              │ │ │
│  │  │  ┌─────────────────────────────────────────────────────────────────────────┐ │ │ │
│  │  │  │                       DRUPAL SERVICE                                    │ │ │ │
│  │  │  │  • ClusterIP service                                                    │ │ │ │
│  │  │  │  • Port 80 → Container port 80                                          │ │ │ │
│  │  │  └─────────────────────────────────────────────────────────────────────────┘ │ │ │
│  │  │                                                                              │ │ │
│  │  │  ┌─────────────────────────────────────────────────────────────────────────┐ │ │ │
│  │  │  │                      INGRESSROUTE (Traefik CRD)                         │ │ │ │
│  │  │  │  • Host: libutk.com                                                     │ │ │ │
│  │  │  │  • TLS: letsencrypt-production                                          │ │ │ │
│  │  │  │  • Middlewares: security-headers, rate-limit                            │ │ │ │
│  │  │  └─────────────────────────────────────────────────────────────────────────┘ │ │ │
│  │  └──────────────────────────────────────────────────────────────────────────────┘ │ │
│  └────────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                          │
│  ┌────────────────────────────────────────────────────────────────────────────────────┐ │
│  │                           AZURE MANAGED SERVICES                                   │ │
│  │                                                                                    │ │
│  │  ┌──────────────────────┐   ┌──────────────────────┐   ┌──────────────────────┐   │ │
│  │  │   AZURE CONTAINER    │   │   AZURE KEY VAULT    │   │  AZURE BLOB STORAGE  │   │ │
│  │  │     REGISTRY (ACR)   │   │                      │   │   (Premium NFS)      │   │ │
│  │  │                      │   │  drupalcsi-test-kv   │   │                      │   │ │
│  │  │ drupalcsitestacr     │   │                      │   │ drupalcsiteststorage │   │ │
│  │  │ .azurecr.io          │   │  • SOPS encryption   │   │                      │   │ │
│  │  │                      │   │    key               │   │  • drupal-files      │   │ │
│  │  │  • drupal:v1.0.x     │   │  • Managed Identity  │   │    container         │   │ │
│  │  │    images            │   │    access            │   │  • NFS v3 enabled    │   │ │
│  │  │  • Image automation  │   │                      │   │  • HNS enabled       │   │ │
│  │  │    watches for tags  │   │                      │   │                      │   │ │
│  │  └──────────────────────┘   └──────────────────────┘   └──────────────────────┘   │ │
│  │                                                                                    │ │
│  │  ┌────────────────────────────────────┐   ┌────────────────────────────────────┐  │ │
│  │  │     AZURE POSTGRESQL (eastus2)     │   │      AZURE CACHE FOR REDIS        │  │ │
│  │  │                                    │   │                                    │  │ │
│  │  │  drupalcsi-test-pg.postgres.       │   │  drupalcsi-test-redis.redis.      │  │ │
│  │  │  database.azure.com                │   │  cache.windows.net                │  │ │
│  │  │                                    │   │                                    │  │ │
│  │  │  • Database: drupal11              │   │  • Port: 6380 (TLS)               │  │ │
│  │  │  • SSL/TLS enforced                │   │  • PhpRedis extension             │  │ │
│  │  │  • Port: 5432                      │   │  • All cache bins except forms    │  │ │
│  │  │  • ~1-2ms latency (cross-region)   │   │  • Bootstrap container cache      │  │ │
│  │  └────────────────────────────────────┘   └────────────────────────────────────┘  │ │
│  └────────────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

## GitOps Flow

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                    GITOPS WORKFLOW                                       │
│                                                                                          │
│  ┌─────────────────┐                                      ┌─────────────────────────┐   │
│  │    DEVELOPER    │                                      │        GITHUB           │   │
│  │                 │                                      │                         │   │
│  │  1. Code change │─────────────────────────────────────▶│  drupal-gitops repo     │   │
│  │     in drupal-  │                                      │                         │   │
│  │     gitops/     │                                      │  • infrastructure/      │   │
│  │                 │                                      │  • apps/                │   │
│  │  2. Or: push    │─────────────────────────────────────▶│  • clusters/            │   │
│  │     new image   │                                      │                         │   │
│  │     to ACR      │                                      └───────────┬─────────────┘   │
│  └─────────────────┘                                                  │                 │
│                                                                       │ poll every      │
│                                                                       │ 1 minute        │
│                                                                       ▼                 │
│  ┌────────────────────────────────────────────────────────────────────────────────────┐ │
│  │                              FLUXCD (in cluster)                                   │ │
│  │                                                                                    │ │
│  │  ┌─────────────────────┐    ┌─────────────────────┐    ┌─────────────────────┐    │ │
│  │  │  source-controller  │    │ kustomize-controller│    │ image-reflector-    │    │ │
│  │  │                     │    │                     │    │ controller          │    │ │
│  │  │  Detects new        │───▶│  Builds & applies   │    │                     │    │ │
│  │  │  commits in Git     │    │  Kustomizations     │    │  Watches ACR for    │    │ │
│  │  │                     │    │                     │    │  new image tags     │    │ │
│  │  │                     │    │  Decrypts SOPS      │    │                     │    │ │
│  │  │                     │    │  secrets via        │    │  Updates image tag  │    │ │
│  │  │                     │    │  Workload Identity  │    │  in Git repo        │    │ │
│  │  └─────────────────────┘    └─────────────────────┘    └─────────────────────┘    │ │
│  │                                        │                                          │ │
│  │                                        ▼                                          │ │
│  │  ┌────────────────────────────────────────────────────────────────────────────┐   │ │
│  │  │                        RECONCILIATION ORDER                                │   │ │
│  │  │                                                                            │   │ │
│  │  │   ┌──────────────┐      ┌──────────────┐      ┌──────────────┐            │   │ │
│  │  │   │infrastructure│─────▶│ certificates │─────▶│drupal-migrate│            │   │ │
│  │  │   │              │      │              │      │    (Job)     │            │   │ │
│  │  │   │ • storage    │      │ • ClusterIssuer    │ • updatedb   │            │   │ │
│  │  │   │ • traefik    │      │ • Certificate │     │ • config:    │            │   │ │
│  │  │   │ • cert-mgr   │      │   for libutk  │     │   import     │            │   │ │
│  │  │   │ • namespaces │      │   .com        │      │              │            │   │ │
│  │  │   └──────────────┘      └──────────────┘      └──────┬───────┘            │   │ │
│  │  │                                                       │                    │   │ │
│  │  │                                                       ▼ success            │   │ │
│  │  │                                               ┌──────────────┐             │   │ │
│  │  │                                               │    apps      │             │   │ │
│  │  │                                               │              │             │   │ │
│  │  │                                               │ • Deployment │             │   │ │
│  │  │                                               │ • Service    │             │   │ │
│  │  │                                               │ • CronJob    │             │   │ │
│  │  │                                               │ • Ingress    │             │   │ │
│  │  │                                               └──────────────┘             │   │ │
│  │  └────────────────────────────────────────────────────────────────────────────┘   │ │
│  └────────────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

## Request Flow

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              HTTP REQUEST FLOW                                           │
│                                                                                          │
│     User Request                                                                         │
│          │                                                                               │
│          ▼                                                                               │
│  ┌───────────────┐                                                                       │
│  │  DNS Lookup   │  libutk.com → 172.171.194.237                                        │
│  └───────┬───────┘                                                                       │
│          │                                                                               │
│          ▼                                                                               │
│  ┌───────────────┐                                                                       │
│  │ Azure Load    │  Static IP bound to Traefik LoadBalancer Service                     │
│  │ Balancer      │                                                                       │
│  └───────┬───────┘                                                                       │
│          │                                                                               │
│          ▼                                                                               │
│  ┌───────────────┐                                                                       │
│  │   TRAEFIK     │  • TLS termination (Let's Encrypt cert)                              │
│  │               │  • Security headers middleware                                        │
│  │               │  • Rate limiting                                                      │
│  │               │  • Routes to Drupal service                                           │
│  └───────┬───────┘                                                                       │
│          │                                                                               │
│          ▼                                                                               │
│  ┌───────────────┐                                                                       │
│  │ Drupal Service│  ClusterIP → Pod selector                                            │
│  │               │                                                                       │
│  └───────┬───────┘                                                                       │
│          │ (round-robin to pods)                                                         │
│          ▼                                                                               │
│  ┌───────────────┐                                                                       │
│  │  DRUPAL POD   │                                                                       │
│  │  ┌─────────┐  │                                                                       │
│  │  │  nginx  │  │  • Serves static files directly                                      │
│  │  │ :80     │  │  • /health endpoint (200 OK)                                         │
│  │  │         │  │  • Proxies PHP to php-fpm                                            │
│  │  └────┬────┘  │                                                                       │
│  │       │       │                                                                       │
│  │       ▼       │                                                                       │
│  │  ┌─────────┐  │                                                                       │
│  │  │ php-fpm │  │  • OPcache (JIT enabled, no timestamp validation)                    │
│  │  │ :9000   │  │  • PhpRedis for caching                                              │
│  │  │         │  │  • PDO for PostgreSQL                                                │
│  │  └────┬────┘  │                                                                       │
│  │       │       │                                                                       │
│  └───────┼───────┘                                                                       │
│          │                                                                               │
│          ├─────────────────────┬──────────────────────┬─────────────────────────────────│
│          │                     │                      │                                  │
│          ▼                     ▼                      ▼                                  │
│  ┌───────────────┐    ┌───────────────┐     ┌────────────────┐                          │
│  │  PostgreSQL   │    │    Redis      │     │  Azure Blob    │                          │
│  │  (eastus2)    │    │  (eastus)     │     │  Storage NFS   │                          │
│  │               │    │               │     │  (eastus)      │                          │
│  │  • Database   │    │  • Page cache │     │                │                          │
│  │    queries    │    │  • Render     │     │  • File reads  │                          │
│  │  • TLS on     │    │    cache      │     │    (actimeo=60 │                          │
│  │    5432       │    │  • Bootstrap  │     │    caching)    │                          │
│  │               │    │    container  │     │  • Image styles│                          │
│  │               │    │  • TLS on     │     │  • Uploads     │                          │
│  │               │    │    6380       │     │                │                          │
│  └───────────────┘    └───────────────┘     └────────────────┘                          │
│                                                                                          │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

## Storage Architecture (The Key Differentiator)

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                           STORAGE ARCHITECTURE                                           │
│                                                                                          │
│  ┌─────────────────────────────────────────────────────────────────────────────────────┐│
│  │                        WHY NOT PHP STORAGE MODULES?                                 ││
│  │                                                                                     ││
│  │   ❌ PHP modules (flysystem, az_blob_fs):                                          ││
│  │      • Each stat() call = 1 network request = 1-3ms latency                        ││
│  │      • Drupal makes ~5,000 stat() calls per page load                              ││
│  │      • Result: 5-15 SECONDS of storage latency per request!                        ││
│  │                                                                                     ││
│  │   ✅ Our approach (Azure Blob CSI Driver with NFS):                                ││
│  │      • Mount at Kubernetes level, not PHP level                                    ││
│  │      • Kernel-level metadata caching (actimeo=60)                                  ││
│  │      • First stat() = network, next 4,999 = kernel cache (~0ms)                    ││
│  │      • Result: Near-local performance!                                             ││
│  └─────────────────────────────────────────────────────────────────────────────────────┘│
│                                                                                          │
│                                                                                          │
│    ┌────────────────────────────────────────────────────────────────────────────────┐   │
│    │                         VOLUME MOUNT DETAILS                                   │   │
│    │                                                                                │   │
│    │   ┌──────────────────────────────────────────────────────────────────────┐    │   │
│    │   │              PERSISTENT VOLUME CLAIM (Azure Blob NFS)                │    │   │
│    │   │                                                                      │    │   │
│    │   │   Name: drupal-files                                                 │    │   │
│    │   │   StorageClass: azure-blob-nfs                                       │    │   │
│    │   │   Mount Path: /var/www/html/web/sites/default/files                  │    │   │
│    │   │                                                                      │    │   │
│    │   │   Mount Options:                                                     │    │   │
│    │   │   ┌────────────────────────────────────────────────────────────┐     │    │   │
│    │   │   │  • actimeo=60    → Cache metadata for 60 seconds          │     │    │   │
│    │   │   │  • nconnect=8    → 8 parallel TCP connections             │     │    │   │
│    │   │   │  • noatime       → Don't update access times              │     │    │   │
│    │   │   │  • rsize=1048576 → 1MB read buffer                        │     │    │   │
│    │   │   │  • wsize=1048576 → 1MB write buffer                       │     │    │   │
│    │   │   └────────────────────────────────────────────────────────────┘     │    │   │
│    │   │                                                                      │    │   │
│    │   │   Contents:                                                          │    │   │
│    │   │   • User uploads                                                     │    │   │
│    │   │   • Image style derivatives                                          │    │   │
│    │   │   • CSS/JS aggregates                                                │    │   │
│    │   │   • Public files                                                     │    │   │
│    │   └──────────────────────────────────────────────────────────────────────┘    │   │
│    │                                                                                │   │
│    │   ┌──────────────────────────────────────────────────────────────────────┐    │   │
│    │   │                    EMPTYDIR (Memory-backed)                          │    │   │
│    │   │                                                                      │    │   │
│    │   │   Mount Path: /tmp                                                   │    │   │
│    │   │   Medium: Memory                                                     │    │   │
│    │   │                                                                      │    │   │
│    │   │   Contents:                                                          │    │   │
│    │   │   • Twig compiled templates                                          │    │   │
│    │   │   • Temporary files                                                  │    │   │
│    │   │   • Session files (if file-based)                                    │    │   │
│    │   │                                                                      │    │   │
│    │   │   ⚠️  Lost on pod restart (rebuilt ~500ms-2s on first request)       │    │   │
│    │   └──────────────────────────────────────────────────────────────────────┘    │   │
│    │                                                                                │   │
│    │   ┌──────────────────────────────────────────────────────────────────────┐    │   │
│    │   │                    EMPTYDIR (Standard)                               │    │   │
│    │   │                                                                      │    │   │
│    │   │   Mount Path: /var/www/private                                       │    │   │
│    │   │                                                                      │    │   │
│    │   │   Contents:                                                          │    │   │
│    │   │   • Private files (not web-accessible)                               │    │   │
│    │   │                                                                      │    │   │
│    │   │   ⚠️  Lost on pod restart                                            │    │   │
│    │   └──────────────────────────────────────────────────────────────────────┘    │   │
│    └────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                          │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

## FluxCD Kustomization Dependencies

```
                    ┌──────────────────────┐
                    │   flux-system        │
                    │   (bootstrap)        │
                    └──────────┬───────────┘
                               │
                               ▼
                    ┌──────────────────────┐
                    │   infrastructure     │
                    │                      │
                    │  • storage/          │
                    │  • traefik/          │
                    │  • cert-manager/     │
                    │  • namespaces/       │
                    └──────────┬───────────┘
                               │
                               ▼
                    ┌──────────────────────┐
                    │   certificates       │
                    │                      │
                    │  • ClusterIssuer     │
                    │  • Certificate       │
                    │    (libutk.com)      │
                    └──────────┬───────────┘
                               │
                               ▼
                    ┌──────────────────────┐
                    │   drupal-migration   │
                    │   (apps-migration)   │
                    │                      │
                    │  • Job: drush        │
                    │    updatedb,         │
                    │    config:import     │
                    └──────────┬───────────┘
                               │ (must succeed)
                               ▼
                    ┌──────────────────────┐
                    │   apps               │
                    │                      │
                    │  • Deployment        │
                    │  • Service           │
                    │  • CronJob           │
                    │  • IngressRoute      │
                    └──────────────────────┘
```

## Security Architecture

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              SECURITY LAYERS                                             │
│                                                                                          │
│  ┌────────────────────────────────────────────────────────────────────────────────────┐ │
│  │                           EXTERNAL TRAFFIC                                         │ │
│  │  ┌───────────────────────────────────────────────────────────────────────────┐    │ │
│  │  │  TLS Termination (Let's Encrypt)                                          │    │ │
│  │  │  • Certificate auto-renewal via cert-manager                              │    │ │
│  │  │  • HTTP → HTTPS redirect                                                  │    │ │
│  │  └───────────────────────────────────────────────────────────────────────────┘    │ │
│  │  ┌───────────────────────────────────────────────────────────────────────────┐    │ │
│  │  │  Traefik Middlewares                                                      │    │ │
│  │  │  • Security headers (X-Frame-Options, CSP, etc.)                          │    │ │
│  │  │  • Rate limiting                                                          │    │ │
│  │  └───────────────────────────────────────────────────────────────────────────┘    │ │
│  └────────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                          │
│  ┌────────────────────────────────────────────────────────────────────────────────────┐ │
│  │                           SECRETS MANAGEMENT                                       │ │
│  │  ┌───────────────────────────────────────────────────────────────────────────┐    │ │
│  │  │  SOPS Encryption                                                          │    │ │
│  │  │  • All secrets encrypted in Git                                           │    │ │
│  │  │  • Azure Key Vault stores encryption key                                  │    │ │
│  │  │  • Workload Identity for decryption (no stored credentials)               │    │ │
│  │  └───────────────────────────────────────────────────────────────────────────┘    │ │
│  └────────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                          │
│  ┌────────────────────────────────────────────────────────────────────────────────────┐ │
│  │                           DATABASE CONNECTIONS                                     │ │
│  │  ┌───────────────────────────────────────────────────────────────────────────┐    │ │
│  │  │  PostgreSQL                                                               │    │ │
│  │  │  • TLS enforced by Azure (no plaintext option)                            │    │ │
│  │  │  • Connection via private endpoint (within Azure)                         │    │ │
│  │  └───────────────────────────────────────────────────────────────────────────┘    │ │
│  │  ┌───────────────────────────────────────────────────────────────────────────┐    │ │
│  │  │  Redis                                                                    │    │ │
│  │  │  • TLS required on port 6380                                              │    │ │
│  │  │  • Auth key stored in SOPS-encrypted secret                               │    │ │
│  │  └───────────────────────────────────────────────────────────────────────────┘    │ │
│  └────────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                          │
│  ┌────────────────────────────────────────────────────────────────────────────────────┐ │
│  │                           POD SECURITY                                             │ │
│  │  ┌───────────────────────────────────────────────────────────────────────────┐    │ │
│  │  │  • Runs as non-root (UID 82 / www-data)                                   │    │ │
│  │  │  • No privileged containers                                               │    │ │
│  │  │  • fsGroup: 82 for volume permissions                                     │    │ │
│  │  │  • Resource limits enforced                                               │    │ │
│  │  └───────────────────────────────────────────────────────────────────────────┘    │ │
│  └────────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                          │
│  ┌────────────────────────────────────────────────────────────────────────────────────┐ │
│  │                           ACR / IMAGE SECURITY                                     │ │
│  │  ┌───────────────────────────────────────────────────────────────────────────┐    │ │
│  │  │  • AKS uses Managed Identity to pull from ACR                             │    │ │
│  │  │  • No imagePullSecrets needed                                             │    │ │
│  │  │  • Images scanned (if Microsoft Defender enabled)                         │    │ │
│  │  └───────────────────────────────────────────────────────────────────────────┘    │ │
│  └────────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                          │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---

*Generated: December 2025*
*Project: Drupal 11 on Azure Kubernetes Service*
